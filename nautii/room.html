<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nautii Girls</title>

    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <link href="https://unpkg.com/nes.css@latest/css/nes.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.min.css">
    
    <style>
        /* BASE AND LAYOUT */
        html, body {
            height: 100%; margin: 0; overflow: hidden;
            background-color: #000; font-family: 'Press Start 2P', cursive;
        }
        .game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; background-color: #000; }
        .room {
            display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            align-items: center; justify-content: center; flex-direction: column; text-align: center;
            padding: 20px; box-sizing: border-box; opacity: 0; visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
        }
        .room.active { display: flex; opacity: 1; visibility: visible; }
        .ui-panel {
            z-index: 10; padding: 1.5rem 2rem; position: relative;
            background-color: rgba(255, 255, 255, 0.9); max-width: 800px;
        }
        .ui-panel.is-dark { background-color: rgba(33, 37, 41, 0.9); }
        .room-description {
            position: absolute; top: 20px; left: 20px; max-width: 45%;
            text-align: left; z-index: 20; font-size: 0.8rem; line-height: 1.5;
        }

        /* --- TITLE SCREEN --- */
        #title-screen { background-color: #000; color: #fff; }
        #title-screen h1 { font-size: 3rem; margin-bottom: 2rem; text-shadow: 4px 4px #e50081; }
        #title-screen .title-copyright { margin-top: 2rem; font-size: 0.8rem; }
        .title-menu .nes-btn { margin: 1rem; }
        .title-container .nes-icon.star { margin: 0 1rem; }

        /* --- ROOM STYLES & AMBIENT ANIMATIONS --- */
        #room-1 { background-color: #a7c957; }
        @keyframes sway { 0%, 100% { transform: rotate(-1deg); } 50% { transform: rotate(1deg); } }
        #room-1 .key { animation: sway 4s ease-in-out infinite; }
        
        #room-2 { background-color: #495057; color: #fff; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 15px #212529; } 50% { box-shadow: 0 0 35px 5px #adb5bd; } }
        #room-2 .ui-panel { animation: pulse-glow 6s ease-in-out infinite; }

        #room-3 { background-color: #4c007d; position: relative; }
        #room-3::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 5;
            animation: scan-lines 20s linear infinite;
        }
        @keyframes scan-lines { from { background-position: 0 0; } to { background-position: 0 -100px; } }

        #room-4 { 
            color: #fff; 
            background: #000814 url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABoSURBVFhH7c6xCQAgEANBvf9p7h7g0kpaaC21pLf83wCAeS2AAG4BIMAtAAS4BYAAtwAQ4BYAAtwCwABsAcCAAQAHCgAAfKgAcOCAAcCCBQAAFyggAOCBAgAAFyggAAB+vQG9Vb4c5ArdOgAAAABJRU5ErkJggg==') repeat;
            animation: scroll-bg 40s linear infinite;
        }
        @keyframes scroll-bg { from { background-position: 0 0; } to { background-position: 256px 256px; } }

        #room-5 { background-color: #111; color: #fff; }
        .particle { position: absolute; background: white; border-radius: 50%; opacity: 0; }
        @keyframes drift { 0% { opacity: 0; } 20% { opacity: 0.5; } 80% { opacity: 0.5; } 100% { opacity: 0; transform: translateY(-100vh); } }
        @keyframes zoom-star { 0% { transform: scale(0) rotate(0deg); top: 50%; left: 50%; opacity: 1; } 100% { transform: scale(3) rotate(360deg); top: var(--y-end); left: var(--x-end); opacity: 0; } }

        /* ROOM 1: KEYBOARD */
        #keyboard-container { display: flex; flex-direction: column; gap: 8px; margin-top: 20px; }
        .keyboard-row { display: flex; gap: 8px; justify-content: center; }
        .key { width: 40px; height: 40px; padding: 0; }
        #answer-display { min-height: 48px; padding: 10px; font-size: 24px; letter-spacing: 8px; margin: 10px 0; width: 250px; text-align: center; }

        /* ROOM 2: HALLWAY */
        #flicker-container { background: rgba(0,0,0,0.8); color: #fff; padding: 20px; z-index: 10; font-size: 1.2rem; margin-bottom: 2rem; }
        #flicker-code { display: inline-block; width: 400px; text-align: center; animation: lightning-strike 3.5s linear infinite; }
        @keyframes lightning-strike { 0%,70%{color:transparent;text-shadow:none}81%{color:#fff;text-shadow:0 0 5px #fff,0 0 15px #fff,0 0 25px #66ccff}98%{color:transparent;text-shadow:none}99%{color:#fff;text-shadow:0 0 5px #fff,0 0 10px #66ccff}100%{color:transparent;text-shadow:none} }
        
        /* ROOM 3: ARCADE */
        #note-indicators { display: flex; gap: 1rem; padding: 1rem; min-height: 60px; margin-top: 1rem; justify-content: center; }
        .note-indicator { width: 32px; height: 32px; image-rendering: pixelated; }
        #arcade-machines { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .arcade-machine { width: 80px; height: 120px; cursor: pointer; animation: pulse 1.5s infinite; }
        .arcade-machine:nth-child(1) { background-color: #fcbf49; animation-delay: 0.4s; }
        .arcade-machine:nth-child(2) { background-color: #0077b6; animation-delay: 0.8s; }
        .arcade-machine:nth-child(3) { background-color: #d90429; animation-delay: 0s; }
        .arcade-machine:nth-child(4) { background-color: #2a9d8f; animation-delay: 0.6s; }
        .arcade-machine:nth-child(5) { background-color: #f77f00; animation-delay: 0.2s; }
        @keyframes pulse { 0%,100%{box-shadow:0 0 5px 2px #fff3}50%{box-shadow:0 0 20px 8px #fffffc} }

        /* ROOM 4: CARTRIDGE */
        #drop-zones { display: flex; gap: 10px; margin: 20px 0; border: 4px solid #fff; padding: 10px; }
        .word-drop { min-width: 180px; height: 60px; border: 4px dashed; display: flex; align-items: center; justify-content: center; }
        .word-drop[data-accepts="fever"] { border-color: #e63946; }
        .word-drop[data-accepts="dream"] { border-color: #457b9d; }
        .word-drop[data-accepts="street"] { border-color: #90be6d; }
        .word-drop.drag-over { background: #495057; }
        #drag-words { 
            margin-top: 2rem; display: flex; flex-wrap: wrap; gap: 10px; 
            justify-content: center; max-width: 800px; min-height: 150px; 
            padding: 10px; border-color: #555;
        }
        .word-drag { cursor: grab; }
        .word-drag:active { cursor: grabbing; }
        .word-fever.nes-btn { background-color: #e63946 !important; color: white; }
        .word-dream.nes-btn { background-color: #457b9d !important; color: white; }
        .word-street.nes-btn { background-color: #90be6d !important; color: black; }
        
        /* --- DEGRADATION & SURREAL EFFECTS --- */
        .jitter-effect { animation: jitter 0.2s infinite; }
        @keyframes jitter {
            0% { transform: translate(1px, 1px) rotate(0.1deg); }
            50% { transform: translate(-1px, -1px) rotate(-0.1deg); }
            100% { transform: translate(1px, 1px) rotate(0.1deg); }
        }
        .melty-effect { animation: melty 8s ease-in-out infinite alternate; }
        @keyframes melty {
            from { filter: blur(0px) hue-rotate(0deg); transform: skew(0deg, 0deg); }
            to { filter: blur(1px) hue-rotate(20deg); transform: skew(-1deg, 1deg); }
        }
        .color-shift-effect { animation: color-shift 5s linear infinite; }
        @keyframes color-shift {
            from { filter: hue-rotate(0deg); } to { filter: hue-rotate(360deg); }
        }

        /* EFFECTS */
        #glitch-sprite { display:none; position:fixed; z-index:10000; pointer-events:none; }
        .sprite-is-glitching { display:block !important; animation: sprite-glitch .25s steps(2,end) forwards; }
        @keyframes sprite-glitch { 0%{opacity:0}10%{opacity:1;transform:translate(5px,-10px);clip-path:inset(0 0 50% 0)}30%{transform:translate(-10px,8px);clip-path:inset(50% 0 0 0)}50%{transform:translate(8px,-5px);clip-path:inset(20% 0 40% 0)}80%{transform:translate(-5px,10px);clip-path:inset(0 0 0 0)}100%{opacity:0;display:none} }
        .subtle-shake { animation: subtle-shake 0.3s ease-in-out; }
        @keyframes subtle-shake { 0%,100%{transform:translate(0,0)}25%{transform:translate(-3px,-2px)}50%{transform:translate(2px,3px)}75%{transform:translate(3px,-2px)} }
        #wrong-flash, #correct-flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998;
            display: flex; align-items: center; justify-content: center;
            font-size: 5rem; color: white; text-shadow: 5px 5px black;
        }
        #wrong-flash { background: rgba(255, 0, 0, 0.7); }
        #correct-flash { background: rgba(46, 204, 113, 0.7); }
        #glitch-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            pointer-events: none; z-index: 9999;
        }
        #glitch-overlay.glitch-active::before, 
        #glitch-overlay.glitch-active::after { content: ' '; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; }
        .glitch-light { animation: glitch-effect-light 0.3s steps(2, end) both; }
        .glitch-medium { animation: glitch-effect-medium 0.4s cubic-bezier(.25, .46, .45, .94) both; }
        .glitch-heavy { animation: glitch-effect-heavy 0.5s cubic-bezier(.25, .46, .45, .94) both; }
        .glitch-very-heavy { animation: glitch-effect-very-heavy 0.6s ease-in-out both; }
        @keyframes glitch-effect-light { 10%,60%{transform:translate(-2px,2px)}40%,80%{transform:translate(2px,-2px)} }
        @keyframes glitch-effect-medium { 0%{transform:translate(0)}10%{transform:translate(-5px,5px)}20%{transform:translate(5px,-5px)}30%{transform:translate(-5px,-5px)}40%{transform:translate(5px,5px)}50%{transform:translate(-5px,5px)}60%{transform:translate(5px,-5px)}70%{transform:translate(0,0)} }
        @keyframes glitch-effect-heavy { 0%{transform:translate(0);opacity:1}10%{transform:translate(-10px,10px) skewX(20deg)}20%{transform:translate(10px,-10px) skewX(-20deg)}30%{opacity:0}60%{opacity:1;transform:translate(0,0)} }
        @keyframes glitch-effect-very-heavy { 0%{transform:translate(0);filter:none}10%{transform:translate(-20px,20px) scale(1.1);filter:invert(1)}20%{transform:translate(20px,-20px)}30%{transform:translate(0,0) scale(0.9);filter:invert(1)}50%{transform:scale(1.2);filter:none}70%{transform:translate(15px,15px) skewY(15deg);filter:invert(1)}90%{transform:translate(0,0);filter:none} }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            #title-screen h1 { font-size: 2rem; }
            .room-description {
                position: relative;
                top: auto; left: auto;
                max-width: 90%;
                order: -1; /* Puts description above the main UI panel */
                margin-bottom: 1rem;
                font-size: 0.7rem;
                text-align: center;
            }
            .ui-panel { padding: 1rem 1.5rem; width: 95%; }
            .key { width: 30px; height: 30px; }
            .keyboard-row { gap: 4px; }
            #flicker-container { font-size: 1rem; }
            #flicker-code { width: 90%; }
            #drop-zones { flex-direction: column; align-items: center; }
            .word-drop { min-width: 220px; }
            .word-drag.nes-btn { padding: 0.8rem 1rem; font-size: 0.8rem;}
            #dialogue-options { display: flex; flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>
    <dialog class="nes-dialog" id="generic-dialog">
        <form method="dialog">
            <p class="title"></p>
            <p class="dialog-message"></p>
            <menu class="dialog-menu">
                <button class="nes-btn is-primary">Ok</button>
            </menu>
        </form>
    </dialog>

    <img src="sprite.png" id="glitch-sprite">

    <div class="game-container">
        <section id="title-screen" class="room active">
             <div class="nes-container with-title is-centered is-dark title-container">
                <p class="title"><i class="nes-icon star is-small"></i> Nautii Girls <i class="nes-icon star is-small"></i></p>
                <h1>Nautii Girls</h1>
                <div class="title-menu">
                    <button id="new-game-btn" type="button" class="nes-btn is-primary">New Game</button>
                    <button id="continue-btn" type="button" class="nes-btn">Continue</button>
                </div>
                <p class="title-copyright">©2025 LEOPARD SPOT GAMES</p>
            </div>
        </section>

        <section id="room-1" class="room">
            <div id="room1-desc" class="room-description nes-container is-dark"></div>
            <div class="ui-panel nes-container is-rounded">
                <p>Eve? What do you want, Eve?</p>
                <div id="answer-display" class="nes-input"></div>
                <button type="button" id="backspace-btn" class="nes-btn is-warning">DEL</button>
            </div>
            <div id="keyboard-container"></div>
        </section>

        <section id="room-2" class="room">
            <div id="room2-desc" class="room-description nes-container is-dark"></div>
            <div id="flicker-container">The static whispers... <span id="flicker-code"></span></div>
            <div class="ui-panel nes-container is-dark with-title">
                <p class="title">Locker</p>
                <p>A combination lock! Can you HEAR the numbers?</p>
                <form id="locker-form" autocomplete="off">
                    <div class="nes-field">
                        <input type="text" id="locker-input" class="nes-input is-dark" placeholder="XXX">
                    </div>
                    <button type="submit" class="nes-btn is-primary">Unlock</button>
                </form>
            </div>
        </section>

        <section id="room-3" class="room">
            <div id="room3-desc" class="room-description nes-container is-dark"></div>
            <div class="ui-panel nes-container with-title">
                <p class="title">Arcade</p>
                <p>Each machine plays a tone. Is there Order in Disorder...</p>
            </div>
            <div id="arcade-machines">
                <div class="arcade-machine" data-note="mi"></div>
                <div class="arcade-machine" data-note="so"></div>
                <div class="arcade-machine" data-note="do"></div>
                <div class="arcade-machine" data-note="fa"></div>
                <div class="arcade-machine" data-note="re"></div>
            </div>
            <div id="note-indicators" class="nes-container is-dark"></div>
        </section>

        <section id="room-4" class="room">
            <div id="room4-desc" class="room-description nes-container is-dark"></div>
            <div class="ui-panel nes-container is-rounded is-dark">
                <p>The code is fractured...</p>
                <div id="drop-zones">
                    <div class="word-drop" data-accepts="fever"></div>
                    <div class="word-drop" data-accepts="dream"></div>
                    <div class="word-drop" data-accepts="street"></div>
                </div>
                <button type="button" id="check-words-btn" class="nes-btn is-success">Check</button>
            </div>
            <div id="drag-words" class="nes-container is-dark">
                 <div class="word-drag nes-btn word-fever" data-word="fever-x1" id="drag-fever-x1" draggable="true">ILLNESS</div>
                 <div class="word-drag nes-btn word-dream" data-word="dream" id="drag-dream" draggable="true">DREAM</div>
                 <div class="word-drag nes-btn word-fever" data-word="fever-x2" id="drag-fever-x2" draggable="true">SICKNESS</div>
                 <div class="word-drag nes-btn word-street" data-word="street-x1" id="drag-street-x1" draggable="true">AVENUE</div>
                 <div class="word-drag nes-btn word-fever" data-word="fever" id="drag-fever" draggable="true">FEVER</div>
                 <div class="word-drag nes-btn word-dream" data-word="dream-x1" id="drag-dream-x1" draggable="true">VISION</div>
                 <div class="word-drag nes-btn word-street" data-word="street-x2" id="drag-street-x2" draggable="true">ROAD</div>
                 <div class="word-drag nes-btn word-fever" data-word="fever-x3" id="drag-fever-x3" draggable="true">CHILLS</div>
                 <div class="word-drag nes-btn word-street" data-word="street" id="drag-street" draggable="true">STREET</div>
                 <div class="word-drag nes-btn word-dream" data-word="dream-x2" id="drag-dream-x2" draggable="true">FANTASY</div>
                 <div class="word-drag nes-btn word-street" data-word="street-x3" id="drag-street-x3" draggable="true">LANE</div>
                 <div class="word-drag nes-btn word-fever" data-word="fever-x4" id="drag-fever-x4" draggable="true">AGUE</div>
                 <div class="word-drag nes-btn word-dream" data-word="dream-x3" id="drag-dream-x3" draggable="true">NIGHTMARE</div>
                 <div class="word-drag nes-btn word-street" data-word="street-x4" id="drag-street-x4" draggable="true">BLVD</div>
                 <div class="word-drag nes-btn word-fever" data-word="fever-x5" id="drag-fever-x5" draggable="true">MALADY</div>
                 <div class="word-drag nes-btn word-dream" data-word="dream-x4" id="drag-dream-x4" draggable="true">REVERIE</div>
                 <div class="word-drag nes-btn word-dream" data-word="dream-x5" id="drag-dream-x5" draggable="true">TRANCE</div>
                 <div class="word-drag nes-btn word-street" data-word="street-x5" id="drag-street-x5" draggable="true">COURT</div>
            </div>
        </section>

        <section id="room-5" class="room">
            <div id="room5-desc" class="room-description nes-container is-dark"></div>
            <div class="ui-panel nes-container is-dark">
                <p id="dialogue-text">...</p>
                <div id="dialogue-options">
                    <button type="button" class="nes-btn is-primary" data-choice="y">Yes</button>
                    <button type="button" class="nes-btn is-primary" data-choice="n">No</button>
                </div>
                 <a href="#" id="final-link" class="nes-btn is-success" style="display: none;">Something to remember me by...</a>
            </div>
        </section>
        
        <div id="glitch-overlay"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>

    <script>
        $(document).ready(function() {
            const ANSWERS = { room1: 'APPLE', room2: '808', room3: ['do', 're', 'mi', 'fa', 'so'], room4: ['fever', 'dream', 'street'] };
            const NARRATIVE = { room1: "Where are you??? This orchard... you remember it. Nautii was here. Nautii???", room2: "The bright sun gives way to a long, buzzing hallway. Lockers stand like silent sentinels. Did you and Nautii walk here together? SPEAK HER name.", room3: "The scent of ozone and spilled soda. The ghosts of children's laughter echo between the silent machines. Nautii challenged you to every game in here.", room4: "Raw data. You're inside the code now, surrounded by glowing circuits and fragmented words. The game is breaking apart. You have to find Nautii before it all crashes.", room5: "You find the core. It is not a place, but a presence. It feels... lonely. It feels like a fading photograph. It feels like Nautii." };
            const room2Hints = ["Ate? Oh! Ate!", "The Speaker Hears", "8 0 8"];
            let hintIndex = 0;
            const dialogueTree = [ { text: "Are you still there, player?" }, { text: "You've grown so much. Do you even remember me?" }, { text: "I remember when we would play for hours. Do you want to stay?" }, { text: "But... you have a life now, don't you? Responsibilities?" }, { text: "It's okay. I understand. It was nice to play one last time." }, { text: "You should go. But take this with you." }];
            let roomState = { room1: { currentAnswer: '' }, room3: { sequence: [] }, room5: { dialogueIndex: 0 } };
            let flickerInterval, particleInterval;
            const menuMusic = new Audio('mainmenu.mp3');
            menuMusic.loop = true;

            function playGlitch(intensity) {
                const overlay = $('#glitch-overlay');
                overlay.removeClass().addClass(`glitch-active ${intensity}`);
                setTimeout(() => overlay.removeClass(), 600);
            }

            function transitionToRoom(nextRoomId, roomNumber) {
                const intensityMap = ['light', 'medium', 'heavy', 'very-heavy'];
                playGlitch(intensityMap[roomNumber - 2] || 'light');
                const currentRoom = $('.room.active');
                const nextRoom = $(`#${nextRoomId}`);
                
                // Clear old degradation classes and apply new ones based on progression
                $('.room').removeClass('jitter-effect melty-effect color-shift-effect');
                if (roomNumber >= 3) nextRoom.addClass('jitter-effect');      // Starts in the Arcade
                if (roomNumber >= 4) nextRoom.addClass('melty-effect');       // Starts in the Liminal Space
                if (roomNumber >= 5) nextRoom.addClass('color-shift-effect'); // Starts in the final Space room
                
                setTimeout(() => currentRoom.removeClass('active'), 700);
                setTimeout(() => {
                    nextRoom.addClass('active');
                    const setupFunctionName = `setup${nextRoomId.charAt(0).toUpperCase() + nextRoomId.slice(1).replace('-', '')}`;
                    if (typeof window[setupFunctionName] === 'function') window[setupFunctionName]();
                }, 800);
            }

            function showDialog(title, message, onConfirm) {
                const dialog = $('#generic-dialog');
                dialog.find('.title').text(title);
                dialog.find('.dialog-message').text(message);
                dialog[0].showModal();
                dialog.find('.nes-btn').off('click').one('click', () => { if (typeof onConfirm === 'function') onConfirm(); });
            }

            function startGame() {
                if (!menuMusic.paused) menuMusic.pause();
                setInterval(showGlitchSprite, Math.random() * 5000 + 8000);
                transitionToRoom('room-1', 1);
            }
            
            function showGlitchSprite() {
                const sprite = $('#glitch-sprite');
                const x = Math.random() * 80 + 10;
                const y = Math.random() * 80 + 10;
                sprite.css({ top: `${y}%`, left: `${x}%` }).addClass('sprite-is-glitching');
                setTimeout(() => sprite.removeClass('sprite-is-glitching'), 250);
            }

            window.setupRoom1 = function() {
                $('#room1-desc').text(NARRATIVE.room1);
                const keysLayout = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];
                const keyboardContainer = $('#keyboard-container').empty();
                keysLayout.forEach(rowStr => {
                    const rowDiv = $('<div class="keyboard-row"></div>');
                    rowStr.split('').forEach(key => rowDiv.append(`<button type="button" class="nes-btn key" data-letter="${key}">${key}</button>`));
                    keyboardContainer.append(rowDiv);
                });
                $('.key[data-letter="P"]').parent().append('<button type="button" class="nes-btn key" data-letter="P">P</button>');
                $('.key').each(function(i) { $(this).css('animation-delay', `${(i * 0.1)}s`); });
                $('.key').off('click').on('click', function() {
                    if (roomState.room1.currentAnswer.length < ANSWERS.room1.length) {
                        roomState.room1.currentAnswer += $(this).data('letter');
                        $('#answer-display').text(roomState.room1.currentAnswer);
                        if (roomState.room1.currentAnswer === ANSWERS.room1) {
                            $('#answer-display').addClass('is-success');
                            setTimeout(() => transitionToRoom('room-2', 2), 500);
                        } else if (roomState.room1.currentAnswer.length >= ANSWERS.room1.length) {
                           $('#answer-display').addClass('is-error');
                           setTimeout(() => {
                               $('#answer-display').removeClass('is-error').text('');
                               roomState.room1.currentAnswer = '';
                           }, 1000);
                        }
                    }
                });
                $('#backspace-btn').off('click').on('click', () => {
                     roomState.room1.currentAnswer = roomState.room1.currentAnswer.slice(0, -1);
                     $('#answer-display').text(roomState.room1.currentAnswer);
                });
            }

            window.setupRoom2 = function() {
                 $('#room2-desc').text(NARRATIVE.room2);
                 if (flickerInterval) clearInterval(flickerInterval);
                 hintIndex = -1; 
                 const cycleHints = () => {
                    hintIndex = (hintIndex + 1) % room2Hints.length;
                    $('#flicker-code').text(room2Hints[hintIndex]);
                 };
                 flickerInterval = setInterval(cycleHints, 3500);
                 cycleHints();
                 $('#locker-form').off('submit').on('submit', function(e) {
                    e.preventDefault();
                    if ($('#locker-input').val() === ANSWERS.room2) {
                        clearInterval(flickerInterval);
                        transitionToRoom('room-3', 3);
                    } else {
                        $('#locker-input').addClass('is-error');
                        setTimeout(() => $('#locker-input').removeClass('is-error').val(''), 1000);
                    }
                 });
            }

            window.setupRoom3 = function() {
                $('#room3-desc').text(NARRATIVE.room3);
                $('#note-indicators').empty();
                roomState.room3.sequence = [];
                $('.arcade-machine').off('click').on('click', function() {
                    const note = $(this).data('note');
                    const audio = new Audio(`${note}.mp3`);
                    audio.play().catch(e => console.error(`Sound Error: ${e.message}`));
                    $('#note-indicators').append('<img src="note.png" class="note-indicator">');
                    $(this).css('opacity', 0.5);
                    setTimeout(() => $(this).css('opacity', 1), 200);
                    roomState.room3.sequence.push(note);
                    if (roomState.room3.sequence.length >= ANSWERS.room3.length) {
                        if (JSON.stringify(roomState.room3.sequence) === JSON.stringify(ANSWERS.room3)) {
                            setTimeout(() => transitionToRoom('room-4', 4), 500);
                        } else {
                            const wrongChord = new Audio('chord.mp3');
                            wrongChord.play().catch(e => console.error(`Sound Error: ${e.message}`));
                            $('.ui-panel p').first().text("WRONG").addClass('nes-text is-error');
                            roomState.room3.sequence = [];
                            setTimeout(() => {
                                $('.ui-panel p').first().text("Each machine plays a tone...").removeClass('nes-text is-error');
                                $('#note-indicators').empty();
                            }, 1500);
                        }
                    }
                });
            }

            window.setupRoom4 = function() {
                $('#room4-desc').text(NARRATIVE.room4);
                let draggedElement = null;
                $('.word-drag').off('dragstart').on('dragstart', function() { draggedElement = this; });
                $('#drag-words').off('dragover drop').on('dragover', e => e.preventDefault()).on('drop', function(e) {
                    e.preventDefault();
                    if (draggedElement) $(this).append(draggedElement);
                });
                $('.word-drop').off('dragover drop dragleave').on('dragover', function(e) {
                    e.preventDefault();
                    $(this).addClass('drag-over');
                }).on('dragleave', function() { $(this).removeClass('drag-over');
                }).on('drop', function(e) {
                    e.preventDefault();
                    $(this).removeClass('drag-over');
                    if (draggedElement) {
                        if ($(this).children().length > 0) $('#drag-words').append($(this).children()[0]);
                        $(this).append(draggedElement);
                        draggedElement = null;
                    }
                });
                
                $('#check-words-btn').off('click').on('click', function() {
                    const userSequence = [];
                    $('#drop-zones .word-drop').each(function() { userSequence.push($(this).find('.word-drag').data('word')); });
                    if (JSON.stringify(userSequence) === JSON.stringify(ANSWERS.room4)) {
                        const correctFlash = $('<div id="correct-flash">CORRECT</div>');
                        $('body').append(correctFlash);
                        setTimeout(() => {
                            correctFlash.remove();
                            transitionToRoom('room-5', 5);
                        }, 800);
                    } else {
                        const wrongFlash = $('<div id="wrong-flash">WRONG</div>');
                        $('body').append(wrongFlash);
                        $('.game-container').addClass('subtle-shake');
                        setTimeout(() => {
                            $('.game-container').removeClass('subtle-shake');
                            wrongFlash.remove();
                        }, 400);
                    }
                });
            }

            window.setupRoom5 = function() {
                $('#room5-desc').text(NARRATIVE.room5);
                // Clear any previous particle intervals to prevent duplicates
                if (particleInterval) clearInterval(particleInterval);
                
                const createParticle = (isZooming) => {
                    const particle = $('<div class="particle"></div>');
                    const size = Math.random() * (isZooming ? 3 : 2) + 1;
                    const duration = Math.random() * (isZooming ? 1.5 : 5) + (isZooming ? 0.5 : 2);
                    particle.css({ width: `${size}px`, height: `${size}px` });
                    if(isZooming) {
                        particle.css({
                            '--x-end': `${Math.random() * 200 - 50}%`,
                            '--y-end': `${Math.random() * 200 - 50}%`,
                            'animation': `zoom-star ${duration}s linear forwards`
                        });
                    } else {
                        particle.css({
                            'left': `${Math.random() * 100}%`,
                            'animation': `drift ${duration}s linear forwards ${Math.random() * 5}s`
                        });
                    }
                    $('#room-5').append(particle);
                    setTimeout(() => particle.remove(), duration * 1000);
                };
                
                for(let i=0; i<10; i++) createParticle(false);
                
                setTimeout(() => {
                    let particleRate = 300;
                    const minRate = 10;
                    const acceleration = 0.95;

                    function spawnZoomingParticles() {
                        const particlesToSpawn = particleRate < 50 ? (particleRate < 20 ? 3 : 2) : 1;
                        for (let i = 0; i < particlesToSpawn; i++) {
                            createParticle(true);
                        }
                        
                        if (particleRate > minRate) {
                            particleRate *= acceleration;
                        } else {
                            particleRate = minRate;
                        }
                        
                        setTimeout(spawnZoomingParticles, particleRate);
                    }

                    spawnZoomingParticles();
                }, 1000);

                function advanceDialogue() {
                    if (roomState.room5.dialogueIndex < dialogueTree.length) {
                        $('#dialogue-text').text(dialogueTree[roomState.room5.dialogueIndex].text);
                        if (roomState.room5.dialogueIndex >= dialogueTree.length - 1) {
                            $('#dialogue-options').hide();
                            $('#final-link').show().magnificPopup({
                                type: 'iframe', mainClass: 'mfp-fade',
                                                items: {
                    // Corrected URL with autoplay and mute parameters
                    src: 'https://www.youtube.com/watch?v=dQw4w9WgXcQ&autoplay=1&mute=1'
                },
                                iframe: { patterns: { youtube: { index: 'youtube.com/', id: 'v=', src: 'https://www.youtube.com/embed/%id%?autoplay=1&mute=1' } } },
                                callbacks: { close: function() { showDialog("Goodbye", "Thank you
                            });
                        }
                        roomState.room5.dialogueIndex++;
                    }
                }
                $('#dialogue-options button').off('click').on('click', advanceDialogue);
                advanceDialogue();
            }
            
            // --- INITIALIZE GAME ---
            $(document).one('click', 'body', () => menuMusic.play().catch(e => console.error("Could not play menu music.")));
            $('#new-game-btn').on('click', () => showDialog("New Game", "Always New, Ever True, right...?", startGame));
            $('#continue-btn').on('click', () => showDialog("Corrupted Save", "I don't think I remember that...do you?"));
        });
    </script>
</body>
</html>